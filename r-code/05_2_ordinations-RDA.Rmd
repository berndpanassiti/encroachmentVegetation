---
title: "RDA and Variation partitioning"
author: "Bernd Panassiti"
output: html_document
date: 'created: 23.04.2025, last modified: `r format(Sys.Date(), format="%d.%m.%Y")`'
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown
```{r setup, include=FALSE}
library(knitr)
opts_knit$set(root.dir='../')                     # definining working directory; or normalizePath('../')
opts_chunk$set(fig.align='center',                # aligns all figures
                echo=TRUE,                        # shows r-code
                message=FALSE,                    # suppresses library outputs
                warnings=FALSE,                   # suppresses library outputs
                tidy=TRUE,  # prevents the source code from running off a pdf page
                dev='pdf')
```

```{r}
#Install/load pacman
if(!require(pacman)){install.packages("pacman");require(pacman)}
#Install packages
p_load(tidyverse,dplyr,vegan,ggplot2,ggpubr,magrittr)
```

# load working data
```{r}
load("data/workingdata.RData")
```


# RDA
```{r}
rm(.Random.seed, envir=globalenv())
set.seed(2025)

RDA <- rda(spec_RDA.sqrt, env_RDA[,-1], covar_RDA)
summary(RDA)

anova.cca(RDA, step = 1000) #globaler Test des RDA Ergebnisses
#-> das Ergebnis der RDA ist signifikant

ordiplot(RDA) #Ordiplot

smry <- summary(RDA)
RDAscoresSites  <- data.frame(smry$sites[,1:2])       # sites
RDAscoresSpecies  <- data.frame(smry$species[,1:2])     # species

```

1. RDA axis related to woody encroachment

# Variation Partioning
```{r}
rm(.Random.seed, envir=globalenv())
set.seed(2025)



env_RDA.CovJuv <- env_RDA %>% 
  dplyr::select(Cover_Juvenile)

spe.part.all <- vegan::varpart(spec_RDA.sqrt, 
                        env_RDA.CovJuv,
                        covar_RDA)

plot(spe.part.all,
     Xnames = c( "Cover Juvenile", "Alm"), # name the partitions
     bg = c("seagreen3", "mediumpurple"), alpha = 80, # colour the circles
     digits = 2, # only show 2 digits
     cex = 1.5) #<- Venn diagramm mit Farben und Beschriftung
```


# Dataframe - Agriculture parameter


```{r}
df = RDAscoresSites
df$plot_id = rownames(RDAscoresSites)

RDAscoresSitesTraits <- merge(df, traitsSummaryPlot, by = "plot_id", all.x = TRUE)
```




# Forage value
Linear Regression: RDA1 vs Forage Value

```{r}
df = RDAscoresSitesTraits %>%
  mutate(forageValue = as.numeric(forageValue_weighted)) %>%      # convert FW to numeric
  rename(`Forage Value` = forageValue,
         `RDA1-Value` = RDA1) %>%      # rename for plotting
  filter(!is.na(`Forage Value`), !is.na(`RDA1-Value`))  # remove NA values


gRDA_forage = ggplot(df, aes(y = `Forage Value`, x = `RDA1-Value`)) +
  geom_point(color = "steelblue") +
  geom_smooth(method = "lm", se = TRUE, color = "darkred", fill = "pink") +
  stat_regline_equation(
    aes(label = after_stat(eq.label)),
    label.x = -3,
    label.y = max(df$`Forage Value`, na.rm = TRUE)
  ) +
stat_cor(
  aes(label = after_stat(paste(rr.label, p.label, sep = "~`,`~"))),
  label.x = -3,
  label.y = max(df$`Forage Value`, na.rm = TRUE) - 0.2,
  p.accuracy = 0.001
)+
  theme_minimal() +
  labs(
    title = "",
    y = "Forage Value",
    x = "RDA1-Value"
  ); gRDA_forage
```





# Forest association

Waldartenliste
1.1: geschlossener Wald
1.2: Waldränder und –verlichtungen
2.1: Wald wie im Offenland
2.2: auch Wald, aber Schwerpunkt Offenland

B - Bäume, S - Sträucher, K - Kräuter, E - Epiphyten

### Data preparation
```{r}
df1 = RDAscoresSpecies
df1$species = rownames(RDAscoresSpecies)

df2 = traitsBiotopeForest %>% 
  dplyr::select(species,forestAssociation)

df <- merge(df1, df2, by = "species", all.x = TRUE)



df %<>% group_by(species,forestAssociation )%>%
  dplyr::summarise(RDA1 = mean(RDA1))

# Calculate sample sizes
n_labels <- df %>%
  group_by(forestAssociation) %>%
  summarise(n = n(), .groups = "drop") %>%
  mutate(label = paste0(forestAssociation, "\n(n = ", n, ")"))

# Neuen Vektor für Labels
new_levels <- n_labels$label
names(new_levels) <- n_labels$forestAssociation

# Neue Faktorstufen in der richtigen Reihenfolge mit neuen Labels
df$forestAssociation <- factor(df$forestAssociation,
levels = n_labels$forestAssociation,
labels = new_levels)



# Wilcoxon pairwise comparisons
pw <- pairwise.wilcox.test(df$RDA1, df$forestAssociation, p.adjust.method = "BH")

pvals <- c(
  "1.1-1.2" = 0.79286,
  "1.1-2.1" = 0.00076,
  "1.1-2.2" = 2e-13,
  "1.1-Others" = 7.6e-06,
  "1.2-2.1" = 0.10445,
  "1.2-2.2" = 0.00191,
  "1.2-Others" = 0.00688,
  "2.1-2.2" = 8.5e-08,
  "2.1-Others" = 0.04473,
  "2.2-Others" = 0.13864
)

# In DataFrame umwandeln
letters <- multcompLetters(pvals)$Letters

names(letters) = levels(df$forestAssociation)

sig_letters <- data.frame(
  forestAssociation = names(letters),
  letters = letters
)


positions <- df %>% ungroup() %>%
  dplyr::select(forestAssociation)%>%
  distinct(forestAssociation) %>%
  mutate(pos = 0.44)

sig_letters <- left_join(sig_letters, positions, by = "forestAssociation")
```


	Pairwise comparisons using Wilcoxon rank sum exact test 

data:  df$RDA1 and df$forestAssociation 

       1.1     1.2     2.1     2.2    
1.2    0.79286 -       -       -      
2.1    0.00076 0.10445 -       -      
2.2    2.0e-13 0.00191 8.5e-08 -      
Others 7.6e-06 0.00688 0.04473 0.13864

### Plot
```{r}
gRDA_forest = ggplot(df, aes(x = forestAssociation, 
                             y = RDA1)) +
  geom_boxplot(aes(fill = forestAssociation), color = "black") +
  stat_summary(fun = mean, geom = "point", shape = 20, 
               size = 3, color = "red") +
  geom_text(data = sig_letters,
            aes(x = forestAssociation, y = pos, 
                label = letters),
            inherit.aes = FALSE, size = 4) +
  labs(x = "Forest association", 
       y = "RDA1-Score (Reverse of encroachment)") +
  scale_y_continuous(limits = c(-0.5, 0.47))+
  scale_fill_manual(values = c(
  "#f0f0f0",  # very light grey
  "#d9d9d9",  # light grey
  "#bdbdbd",  # medium grey
  "#969696",  # darkish grey
  "#525252"   # dark grey
  ))+
  theme_minimal() +
  theme(axis.text.x = element_text(),
      panel.background = element_blank(),
      axis.line = element_line(color = "black"),
      legend.position = "none"
    );gRDA_forest
```






# Biotope
table 33 grasslands in intermediate to heigh elevations
table 34 grasslands in low to intermediate  elevations
table 35 dry grasslands in low to intermediate  elevations

### Data preparation
```{r}
df1 = RDAscoresSpecies
df1$species = rownames(RDAscoresSpecies)

traits_selected = traitsBiotopeForest %>% 
  dplyr::select(species,table33,tables34_35, Others)%>% 
  dplyr::distinct()

df2 <- traits_selected %>%
  pivot_longer(
    cols = -c("species"),  # Alle Spalten außer "species"
    names_to = "Biotope",
    values_to = "occ"
  ) 

df2 %<>% dplyr::filter(occ>0)

# reorder factor levels
df2$Biotope <- as.factor(df2$Biotope)
df2$Biotope <- factor(df2$Biotope, 
                      levels = c("table33",
                                 "tables34_35",
                                 "Others"))

df <- merge(df1, df2, 
            by = "species", all.x = TRUE)

# Calculate sample sizes
n_labels <- df %>%
  group_by(Biotope) %>%
  summarise(n = n(), .groups = "drop") %>%
  mutate(label = paste0(Biotope, "\n(n = ", n, ")"))

# Neuen Vektor für Labels
new_levels <- n_labels$label
names(new_levels) <- n_labels$Biotope

# Neue Faktorstufen in der richtigen Reihenfolge mit neuen Labels
df$Biotope <- factor(df$Biotope,
levels = n_labels$Biotope,
labels = new_levels)



# Wilcoxon pairwise comparisons
pw <- pairwise.wilcox.test(df$RDA1, df$Biotope, p.adjust.method = "BH")

pvals <- c(
  "table33-tables3435" = 0.78,
  "table33-Others" = 0.000064,
  "tables3435-Others" = 0.000000017
)

# In DataFrame umwandeln
letters <- multcompLetters(pvals)$Letters

names(letters) = levels(df$Biotope)

sig_letters <- data.frame(
  Biotope = names(letters),
  letters = letters
)


positions <- df %>% ungroup() %>%
  dplyr::select(Biotope)%>%
  distinct(Biotope) %>%
  mutate(pos = 0.48)

sig_letters <- left_join(sig_letters, positions, by = "Biotope")
```

### Plot
```{r}
gRDA_biotope = ggplot(df, aes(x = Biotope, y = RDA1)) +
  geom_boxplot(aes(fill = Biotope), color = "black") +
  stat_summary(fun = mean, geom = "point", shape = 20, size = 3, color = "red") +
  geom_text(data = sig_letters,
            aes(x = Biotope, y = pos, label = letters),
            inherit.aes = FALSE, size = 4) +
  labs(x = "§30 biotope species", 
       y = "RDA1-Score (Reverse of encroachment)") +
  scale_y_continuous(limits = c(-0.5, 0.5)) +
  scale_fill_manual(values = c("#d9d9d9", "#969696", "#525252")) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(),
    panel.background = element_blank(),
    axis.line = element_line(color = "black"),
    legend.position = "none"  # optional: hide legend
  ); gRDA_biotope
```



Tafel 33: Alpine Rase
34 & 35 zusammengefasst: Grünland mäßig

frischer Standorte, Magerstandorte

Bewertungindex: bei 1, schon biotope als gesichert

hypothese: bei früher beweiundg verschiebt sich mehr richtung 34/35





```{r}
save(
  gRDA_forage,gRDA_biotope, gRDA_forest,
  file="results/RDA_plots.RData")
```

