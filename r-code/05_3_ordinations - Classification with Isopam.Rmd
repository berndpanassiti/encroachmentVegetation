---
title: "Ordination analyses"
author: "Bernd Panassiti"
date: 'created: 28.11.2024, last modified: `r format(Sys.Date(), format="%d.%m.%Y")`'
output: pdf_document
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
library(knitr)
opts_knit$set(root.dir='../')                     # definining working directory; or normalizePath('../')
opts_chunk$set(fig.align='center',                # aligns all figures
                echo=TRUE,                        # shows r-code
                message=FALSE,                    # suppresses library outputs
                warnings=FALSE,                   # suppresses library outputs
                tidy=TRUE,  # prevents the source code from running off a pdf page
                dev='pdf')
```


# load packages
```{r}
#Install/load pacman
if(!require(pacman)){install.packages("pacman");require(pacman)}
#Install packages
p_load(tidyverse,dplyr,vegan,ggplot2)
```

# load data and functions
```{r}
load("data/workingdata.RData")

source("r-code/00_functions.r")
```





# Classifikation mit Isopam
## Run Isopam
```{r}
rm(.Random.seed, envir=globalenv())
set.seed(2025)

ip <- isopam::isopam(veg_layer_red)
```


## Hierachie-Style nehmen für gleiche Benennung wie Isotab
```{r Isopam}
clusters <- isopam::clusters(ip, 3, style = "hier") 
clusters
clusters_df <- as.data.frame(clusters)
clusters_df <- clusters_df %>%
                rownames_to_column("Plot")
plot(ip)
```


## Fidelity and frequency of species in clusters

### isotab 1
```{r}
it <- isopam::isotab(ip)
it
```

### isotab 2
```{r}
it2 <- isopam::isotab(ip, 2)
it2


plot(it2, labels = TRUE)


ip2 <- ip$hier$lev.2

# How many observations per cluster?
table(ip2)





# Build a dataframe that can be appended to a terra object
df_ip2 <- data.frame(ip2 = as.factor(ip2))

# Make terra object with plots
coords <- coords[order(coords$Plot_Name), ]
latlon_xy <- terra::vect(coords, geom = c("x_coord", "y_coord"), crs = "EPSG:31468")

latlon_xy <- terra::setValues(latlon_xy, df_ip2)
# Spaltennamen von latlon_xy überprüfen
names(latlon_xy)
head(latlon_xy)

# Falls erforderlich, Plot_Name weiterhin hinzufügen


# Neue Werte mit setValues() hinzufügen

latlon_xy$Plot_Name <- coords$Plot_Name
# Überprüfe die Struktur von latlon_xy, um sicherzustellen, dass Plot_Name erhalten bleibt
head(latlon_xy)
rainbow_colors <- rainbow(9)
custom_colors <- c(
  "1.1" = "darkgreen",
  "1.2" = "#3357FF",
  "1.3" = "darkorange",
  "1.4" = "springgreen2",
  "2.1" = "peachpuff",
  "2.2" = "firebrick",
  "3.1" = "lightskyblue",
  "3.2" = "gold",
  "3.3" = "darkorchid1"
)
# Add classification

mapview::mapview(
  latlon_xy,
  zcol = "ip2",                     # Spalte zur Farbcodierung
  alpha.regions = 1,                # Transparenz der Regionen
  label = latlon_xy$Plot_Name, # Plot_Namen aus latlon_xy!   
  col.regions = custom_colors      # Farbschema
)
```

### isotab 3 - Mit 12 Clustern
```{r}
it3 <- isopam::isotab(ip, 3)
it3

#Tabelle aus Isotab machen
it3_df <- as.data.frame(it3$tab)
it3_df <- it3_df %>%
  rownames_to_column("species")


plot(it3, labels = TRUE)

ip3 <- ip$hier$lev.3

# How many observations per cluster?
table(ip3)


df_ip3 <- data.frame(ip3 = as.factor(ip3))
coords <- coords[order(coords$Plot_Name), ]
latlon_xy <- terra::vect(coords, geom = c("x_coord", "y_coord"), crs = "EPSG:31468")

latlon_xy <- terra::setValues(latlon_xy, df_ip3)
latlon_xy$Plot_Name <- coords$Plot_Name
custom_colors2 <- c(
  "1.1.0" = "darkgreen",
  "1.2.0" = "#3357FF",
  "1.3.0" = "darkorange",
  "1.4.0" = "springgreen2",
  "2.1.0" = "peachpuff",
  "2.2.1" = "firebrick",
  "2.2.2" = "red",
  "3.1.1" = "lightskyblue",
  "3.1.2" = "gold",
  "3.2.0" = "darkorchid1",
  "3.3.1" = "darkolivegreen1",
  "3.3.2" = "burlywood4"
)


mapview::mapview(
  latlon_xy,
  zcol = "ip3",                     # Spalte zur Farbcodierung
  alpha.regions = 1,                # Transparenz der Regionen
  label = latlon_xy$Plot_Name, # Plot_Namen aus latlon_xy!   
  col.regions = custom_colors2      # Farbschema
)
```




# NMDS mit Isopam
## Run NMDS
```{r NMDS Isopam}
rm(.Random.seed, envir=globalenv())
set.seed(2025)

nmdsIsopam <- vegan::metaMDS(veg_layer_red)
autoplot(nmdsIsopam, obscolor = ip2)

# 3. Stresswert extrahieren
stress_value <- round(nmdsIsopam$stress, 3)
```



## Boxplot mit Cover_Juvenile und Klassifikation
###  Isopam 2
```{r}
df = plot_data
df$Cluster_ip2 <- as.factor(ip2)

cluster_control <- df[, c("Plot_ID", "Cluster_ip2")]
print(cluster_control)
# Generate a palette with 8 rainbow colors
rainbow_colors <- rainbow(12)
custom_colors <- c(
  "1.1" = "darkgreen",
  "1.2" = "#3357FF",
  "1.3" = "darkorange",
  "1.4" = "springgreen2",
  "2.1" = "peachpuff",
  "2.2" = "firebrick",
  "3.1" = "lightskyblue",
  "3.2" = "gold",
  "3.3" = "darkorchid1"
)


ggplot(df, aes(x = Cluster_ip2, y = Cover_Juvenile, 
                      fill = Cluster_ip2)) +
  geom_boxplot() +
  scale_fill_manual(values = custom_colors) +
  labs(title = "Isopam-Klassifizierung und Verbuschungsgrad",
       x = "Isopam-Klassen",
       y = "Verbuschung in %") +
  geom_jitter(width = 0.2, size = 2, alpha = 0.8, shape = 21, color = "black", stroke = 0.5) +
  stat_summary(
    fun = mean, 
    aes(shape = "Mittelwert"), # Verknüpfung mit dem Legendenwert
    geom = "point", size = 5,
    color = "black", fill = "white") +
  theme_minimal()  +
  labs(shape = "Legende") +
  # Legenden-Eintrag für Mittelwert
  #scale_shape_manual(values = c("Mittelwert" = 22)) + 
  theme(axis.text.x = element_text(
    size = 10, angle = 45, hjust = 1))
```

###  Isopam 3
```{r}
custom_colors2 <- c(
  "1.1.0" = "darkgreen",
  "1.2.0" = "#3357FF",
  "1.3.0" = "darkorange",
  "1.4.0" = "springgreen2",
  "2.1.0" = "peachpuff",
  "2.2.1" = "firebrick",
  "2.2.2" = "red",
  "3.1.1" = "lightskyblue",
  "3.1.2" = "gold",
  "3.2.0" = "darkorchid1",
  "3.3.1" = "darkolivegreen1",
  "3.3.2" = "burlywood4"
)

df = plot_data
df$Cluster_ip3 <- as.factor(ip3)
cluster_control <- df[, c("Plot_ID", "Cluster_ip3")]

ggplot(df, aes(x = Cluster_ip3, y = Cover_Juvenile, fill = Cluster_ip3)) +
  geom_boxplot() +
  scale_fill_manual(values = custom_colors2) +
  labs(title = "Isopam-Klassifizierung und Verbuschungsgrad",
       x = "Isopam-Klassen",
       y = "Verbuschung in %") +
  geom_jitter(width = 0.2, size = 2, alpha = 0.8, shape = 21, color = "black", stroke = 0.5) +
  stat_summary(
    fun = mean, 
    aes(shape = "Mittelwert"), # Verknüpfung mit dem Legendenwert
    geom = "point", size = 5,
    color = "black", fill = "white") +
  theme_minimal()  +
  labs(shape = "Legende") +
  scale_shape_manual(values = c("Mittelwert" = 22)) + # Legenden-Eintrag für Mittelwert
  theme(axis.text.x = element_text(
    size = 10, angle = 45, hjust = 1))
```

Bei den 12 Clustern sind 3 deutlich verbuscht

## Create a violin plot for the variable pH with corresponding colors
```{r}
df = plot_data
df$Cluster_ip2 <- as.factor(ip2)

cluster_control <- df[, c("Plot_ID", "Cluster_ip2")]

ggplot(df, aes(x = Cluster_ip2, y = Cover_Juvenile, fill = Cluster_ip2)) +
  geom_violin(trim = FALSE) +
  scale_fill_manual(values = custom_colors) +
  labs(title = "Violin Plot of Cover_Juvenile by Cluster",
       x = "Cluster",
       y = "Cover_Juvenile") +
  theme_minimal()
```


# NMDS mit Verbuschung und Klassifikation
```{r}
 # 1) Extrahiere die NMDS-Punkte
nmds_data <- as.data.frame(nmdsIsopam$points) 

# 2) Füge die Verbuschung-Information hinzu
nmds_data$Verbuschung <- as.factor(plot_data$Verbuschung)  # 

# 3) Nur ausführen, wenn die Verbuschung mit 1 und 0 in plot_data ist!
nmds_data$Verbuschung = ifelse(nmds_data$Verbuschung == 0,
                               "unverbuscht", "verbuscht") 
nmds_data$Cluster <- as.factor(clusters_df$clusters)
```



## Formen der Punkte basierend auf 'Verbuschung'
```{r}
custom_colors2 <- c(
  "1.1.0" = "darkgreen",
  "1.2.0" = "#3357FF",
  "1.3.0" = "darkorange",
  "1.4.0" = "springgreen2",
  "2.1.0" = "peachpuff",
  "2.2.1" = "firebrick",
  "2.2.2" = "red",
  "3.1.1" = "lightskyblue",
  "3.1.2" = "gold",
  "3.2.0" = "darkorchid1",
  "3.3.1" = "darkolivegreen1",
  "3.3.2" = "burlywood4"
)

ggplot(nmds_data, aes(x = MDS1, y = MDS2, color = Cluster, shape = Verbuschung)) +
  geom_point(size = 3) +
  labs(
    title = "NMDS mit Isopam-Klassifikation und Verbuschung",
    x = "NMDS1",
    y = "NMDS2") +
  scale_shape_manual(values = c(16, 17)) +  # Setze unterschiedliche Formen, z.B. Kreis und Dreieck
 scale_color_manual(values = custom_colors2) + 
  theme_minimal()+
  annotate("text", x = Inf, y = -Inf,
           label = paste("Stress =", stress_value),
           hjust = 1.1, vjust = -0.5, size = 4)
```



## NMDS mit 12 Clustern
```{r}
df = plot_data
df$Cluster_ip3 <- as.factor(ip3)

nmds_data$Verbuschung <- as.factor(df$Verbuschung)  # Füge die Verbuschung-Information hinzu

# Nur ausführen, wenn die Verbuschung mit 1 und 0 in plot_data ist!
nmds_data$Verbuschung <- ifelse(nmds_data$Verbuschung == 0, "unverbuscht", "verbuscht") 
nmds_data$Verbuschung <- as.factor(nmds_data$Verbuschung)
nmds_data$Cluster <- df$Cluster_ip3

# Erstelle den Plot mit ggplot und unterscheide die Formen der Punkte basierend auf 'Verbuschung'
ggplot(nmds_data, aes(x = MDS1, y = MDS2, color = Cluster, shape = Verbuschung)) +
  geom_point(size = 3) +
  labs(
    title = "NMDS mit Isopam-Klassifikation und Verbuschung",
    x = "NMDS1",
    y = "NMDS2"
  ) +
  scale_shape_manual(values = c(16, 17)) +  # Setze unterschiedliche Formen, z.B. Kreis und Dreieck
  scale_color_manual(values = custom_colors2) + 
  theme_minimal()+
  annotate("text", x = Inf, y = -Inf,
           label = paste("Stress =", stress_value),
           hjust = 1.1, vjust = -0.5, size = 4)
```


## NMDS with Isopam with 12 clusters
### Elevation - Encroachment - Slope

NMDS mit 12 Clustern und Umweltparametern

```{r}
plot_data_sorted <- plot_data[match(rownames(veg_layer_red), plot_data$Plot_ID), ]

# Je nach Bedarf 
fit <- envfit(nmdsIsopam,
              plot_data_sorted[, c(
                "Elevation","Cover_Juvenile", "Hangneigung")],
              permutations = 999)

vector_fit <- as.data.frame(fit$vectors$arrows)
vector_fit$Variable <- rownames(vector_fit)
vector_fit <- vector_fit %>% rename(MDS1 = NMDS1)
vector_fit <- vector_fit %>% rename(MDS2 = NMDS2)

# ggplot2-Plot
vector_fit$label_x <- vector_fit$MDS1 + 0.19

nmds_data$Verbuschung <- as.factor(nmds_data$Verbuschung)

ggplot() +
  geom_point(
    data = nmds_data,
    aes(x = MDS1, y = MDS2, color = Cluster, shape = Verbuschung),
    size = 3
  ) +
  labs(
    title = "NMDS mit Isopam-Klassifikation und Verbuschung",
    x = "NMDS1",
    y = "NMDS2"
  ) +
  scale_color_manual(values = custom_colors2) +
  geom_segment(data = vector_fit, aes(x = 0, y = 0, 
                                      xend = MDS1, yend = MDS2),
               arrow = arrow(length = unit(0.2, "cm")), 
               color = "black", linewidth = 1) +
  geom_text(data = vector_fit, aes(x = MDS1, y = MDS2, label = Variable),
                        color = "black", vjust = 0.1) +
  theme_minimal()+
  annotate("text", x = Inf, y = -Inf,
           label = paste("Stress =", stress_value),
           hjust = 1.1, vjust = -0.5, size = 4)
```



### Ellenberg
```{r}
plot_data_sorted <- plot_data[match(rownames(veg_layer_red), plot_data$Plot_ID), ]

fit <- envfit(nmdsIsopam, zeigerwerte_mittel[, c("Lichtzahl", "Temperaturzahl", "Feuchtezahl", "Reaktionszahl", "Naehrstoffzahl")], permutations = 999)
vector_fit <- as.data.frame(fit$vectors$arrows)
vector_fit$Variable <- rownames(vector_fit)
vector_fit <- vector_fit %>% rename(MDS1 = NMDS1)
vector_fit <- vector_fit %>% rename(MDS2 = NMDS2)

# ggplot2-Plot
vector_fit$label_x <- vector_fit$MDS1 + 0.19

nmds_data$Verbuschung <- as.factor(nmds_data$Verbuschung)

ggplot() +
  geom_point(
    data = nmds_data,
    aes(x = MDS1, y = MDS2, color = Cluster, shape = Verbuschung),
    size = 3
  ) +
  labs(
    title = "NMDS mit Isopam-Klassifikation und Verbuschung",
    x = "NMDS1",
    y = "NMDS2"
  ) +
  scale_color_manual(values = custom_colors2) +
  geom_segment(data = vector_fit, aes(x = 0, y = 0, xend = MDS1, yend = MDS2),
               arrow = arrow(length = unit(0.2, "cm")), color = "black", linewidth = 1) +
  geom_text(data = vector_fit, aes(x = MDS1, y = MDS2, label = Variable),
                        color = "black", vjust = 0.1) +
  theme_minimal()+
  annotate("text", x = Inf, y = -Inf,
           label = paste("Stress =", stress_value),
           hjust = 1.1, vjust = -0.5, size = 4)
```


## Plot für jede Art
```{r,eval=FALSE}
pdf(paste("figures/",gsub("-",".",Sys.Date()),"-NMDS_plots_species_isopam1.pdf",sep=""), width = 8, height = 6)

# Iteriere über die Spalten in veg_layer_red (jede Spalte ist eine Art)
for (species in colnames(veg_layer_red)) {
  
  # Daten vorbereiten
  plot_data <- data.frame(
    NMDS1 = nmdsIsopam$points[, 1],
    NMDS2 = nmdsIsopam$points[, 2],
    Verbuschung = plot_data$Verbuschung,
    Cover = veg_layer_red[[species]]
  )
  
  # Erstelle den Plot für jede Art
  p <- ggplot(plot_data, aes(x = NMDS1, y = NMDS2)) +
    geom_point(
      aes(
        color = ip2,
        size = Cover,
        shape = Verbuschung
      )
    ) +
    scale_shape_manual(values = c(16, 17)) +  # Formen für Verbuschung (z. B. Kreis und Dreieck)
    ggtitle(species) +  # Setze den Artnamen als Titel
    theme_minimal()  # Optional: Minimales Design
  
  # Drucke den Plot (es wird nur der aktuelle Plot für die Art gedruckt)
  print(p)
}

# Schließe das PDF-Dokument
dev.off()
```
  
# save
```{r}
save(
  ip, # isopam classification
  it, it2, it3, # isotab, How many observations per cluster?
  nmdsIsopam,
  file="results/isopam.RData"
)
```

